name: Build bun-compatible Playwright Docker image

on:
  workflow_dispatch: 
    inputs:
      event_name: 
        type: choice
        description: Simulate the event that triggered the workflow
        default: push
        options:
          - push
          - pull_request
      tag:
        type: string
        description: Set playwright tag to build. Defaults to the current tag
        required: false

  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      packages: write
    strategy:
      matrix:
        include:
          - registry: ghcr.io
            path: ${{ github.repository }}
            user: ${{ github.actor }}
          - registry: docker.io
            path: gwennlbh/playwright-bun 
            user: gwennlbh
    steps:
      - if: matrix.registry == 'ghcr.io'
        name: Login to ghcr.io
        uses: docker/login-action@v3
        with:
          registry: ${{ matrix.registry }}
          username: ${{ matrix.user }}
          password: ${{ github.token }}
      - if: matrix.registry == 'docker.io'
        name: Login to docker.io
        uses: docker/login-action@v3
        with:
          registry: ${{ matrix.registry }}
          username: ${{ matrix.user }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Checkout repository
        uses: actions/checkout@v5
      - if: github.event.inputs.tag
        name: Set Playwright version
        run: |
          sed -i "s/^FROM mcr.microsoft.com\/playwright:.*/FROM mcr.microsoft.com\/playwright:${{ github.event.inputs.tag }}/" Dockerfile
      - name: Get docker image tag
        id: original_image
        run: |
          function tagurl() {
            echo "${{ matrix.registry }}/${{ matrix.path }}:$1"
          }

          if [ "$EVENT" == "pull_request" ]; then
            # only build PR preview images on ghcr.io, it's useless on other registries
            if [ "${{ matrix.registry }}" == "ghcr.io" ]; then
              echo "This is a PR, setting tag to 'pr-${SHAW}'"
              tag="pr-${SHAW}"
              echo "tags=`tagurl $tag`" >> $GITHUB_OUTPUT
            fi
          else
            tag=$(grep ^FROM Dockerfile | cut -d ':' -f 2)
            echo "tags=`tagurl $tag`,`tagurl latest`" >> $GITHUB_OUTPUT
          fi
        env:
          EVENT: ${{ github.event.inputs.event_name || github.event_name }}
          # Shaw! Guarana!! GIT GUD!
          SHAW: ${{ github.sha }}
      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          file: Dockerfile
          push: true
          tags: ${{ steps.original_image.outputs.tags }}

  test:
    if: github.event_name == 'pull_request' || github.event.inputs.event_name == 'pull_request'
    runs-on: ubuntu-latest
    needs: build
    container:
      image: ghcr.io/gwennlbh/playwright-bun:pr-${{ github.sha }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      - name: Install bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - name: Check bun version
        run: bun --version
      - name: Get declared playwright version
        id: playwright
        run: |
          echo "version=$(grep ^FROM Dockerfile | cut -d: -f 2 | cut -d'-' -f1 | sed s/v//)" >> $GITHUB_OUTPUT
      - name: Try running playwright
        run: bunx playwright@${{ steps.playwright.outputs.version }} --version

  cleanup:
    if: always() && (github.event_name == 'pull_request' || github.event.inputs.event_name == 'pull_request')
    runs-on: ubuntu-latest
    needs: [build, test]
    permissions:
      packages: write
    steps:
      - name: Login to ghcr.io
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}
      - name: Delete Docker image
        uses: dataaxiom/ghcr-cleanup-action@v1
        with:
          delete-tags: pr-${{ github.sha }}
          
